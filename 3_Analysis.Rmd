---
title: "Analysis"
output: html_document
date: "2025-06-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## upload necessary packages
library(purrr)
library(tidyverse)
library(piecewiseSEM)
library(lavaan)
library(sem)
library(semPlot)
library(lme4)

## upload necessary data
# burned
perc_burned <- read.csv("data/landscape/reserve_percentburn_20250620.csv")  %>% dplyr::select(-X) 

# tick data
ticks_clean <- read.csv("data/clean/ticks_clean2_20250620.csv") %>% dplyr::select(-X) 

# ndvi 
ndvi <- read.csv("data/landscape/reserve_recovery_ndvi_20250702.csv") %>% dplyr::select(-X)  #20250620

# dist
dist_to_perim <- read.csv("data/landscape/reserve_distancetofireperim_20250620.csv") %>% dplyr::select(-X) 

# nbr
nbr <- read.csv("data/landscape/reserve_dnbr_raster_20250702.csv") %>% dplyr::select(-X) 


# full sem data
sem_data <- read.csv("data/clean/model/ticks_covariates2_20250702.csv") %>% dplyr::select(-X) %>% 
  mutate(treatment = factor(treatment,
                            levels = c("Unburn", "Burn"))) %>% 
  mutate(dist_to_perim_burn = case_when(treatment == "Burn" ~ 0,
                                        TRUE ~ dist_to_perim))
```

#Analysis

##Summary - Ticks
```{r}
## total ticks
sum(ticks_clean$tick_count)

## tick density by treatment
ticks_clean %>% 
  group_by(treatment) %>% 
  summarise(tick_density_mean = round(mean(tick_density),2), 
            tick_density_se = round(sd(tick_density) / sqrt(n()),1)) 

## tick density by veg
ticks_clean %>% 
  group_by(veg_category,treatment) %>% 
  filter(treatment == "Burn") %>%
  #filter(treatment != "Burn") %>% 
  summarise(tick_density_mean = round(mean(tick_density),2), 
            tick_density_se = round(sd(tick_density) / sqrt(n()),1)) 

## tick density by year
ticks_clean %>% 
  group_by(year,treatment) %>% 
  filter(treatment == "Burn") %>%
  #filter(treatment != "Burn") %>% 
  summarise(tick_density_mean = round(mean(tick_density),2), 
            tick_density_se = round(sd(tick_density) / sqrt(n()),1)) 
```

##Wilcoxon rank sum - Ticks
```{r}
## between burn and unburned plots
ticks_burn <- ticks_clean %>% filter(treatment == "Burn" & year == 2022) 

ticks_unburn <- ticks_clean %>% filter(treatment == "Unburn"& year == 2022)

wilcox.test(ticks_burn$tick_density, ticks_unburn$tick_density)
# 2022 : W = 2432, p-value = 8.585e-05


## between vegetation types 
# grassland
ticks_burn_g <- ticks_clean %>% filter(treatment == "Burn" & year == 2022 & veg_category == "Grassland") 

ticks_unburn_g <- ticks_clean %>% filter(treatment == "Unburn"& year == 2022 & veg_category == "Grassland")

wilcox.test(ticks_burn_g$tick_density, ticks_unburn_g$tick_density)
# W = 380, p-value = 0.6997

# shrub
ticks_burn_s <- ticks_clean %>% filter(treatment == "Burn" & year == 2022 & veg_category == "Scrub") 

ticks_unburn_s <- ticks_clean %>% filter(treatment == "Unburn"& year == 2022 & veg_category == "Scrub")

wilcox.test(ticks_burn_s$tick_density, ticks_unburn_s$tick_density)
# W = 189.5, p-value = 0.02164

# forest
ticks_burn_f <- ticks_clean %>% filter(treatment == "Burn" & year == 2022 & veg_category == "Forest") 

ticks_unburn_f <- ticks_clean %>% filter(treatment == "Unburn"& year == 2022 & veg_category == "Forest")

wilcox.test(ticks_burn_f$tick_density, ticks_unburn_f$tick_density)
# W = 246, p-value = 0.0002037
```

##Wildfire characteristics at reserve level
```{r}
## % burned
perc_burned %>% 
  group_by(reserve) %>% 
  summarise(reserve_percentburn = round(reserve_percentburn,2))



## dist from plots to perimeter
dist_to_perim %>% 
  filter(treatment == "Unburn") %>% 
  group_by(reserve) %>% 
  summarise(dist_to_perim_mean = round(mean(dist_to_perim,na.rm = TRUE),2),
            dist_to_perim_se = round(sd(dist_to_perim) / sqrt(n()),1))
```

##SEM
(Need to fix)

OLD - Inclusive model
```{r}

mod_inclusive <- psem(
  # local model
  lm(log(tick_density+1) ~ 
       soil_surface_severity +
       avg_woody_debris + 
       reserve_burn + distance_to_perim +
       tmean_normal + precip_cum_mean,
     data = sem_data3),
  
  lmer(avg_woody_debris ~ 
         soil_surface_severity +
         precip_cum_mean + tmean_normal + 
         reserve_burn + distance_to_perim + (1|veg_category), data = sem_data3),

  
  lm(soil_surface_severity ~ 
       reserve_burn +  distance_to_perim  +
       precip_cum_mean + tmean_normal, data = sem_data3),
  
  lm(reserve_burn ~ 
       precip_cum_mean + tmean_normal, data = sem_data3)
)  

summary(mod_inclusive)
plot(mod_inclusive)
# 5340.206
# Fisher's C = 4.616 with P-value = 0.099 and on 2 degrees of freedom

```

NEW- Inclusive model
```{r}
mod_inclusive_new <- psem(
  # local model
  lm(log(tick_density+1) ~ 
       soil_surface_severity_mean +
       woody_debris_mean + 
       reserve_percentburn + dist_to_perim +
       tmean_normal + ppt_mean_overall,
     data = sem_data),
  
  lmer(woody_debris_mean ~ 
         soil_surface_severity_mean +
         ppt_mean_overall + tmean_normal + 
         reserve_percentburn + dist_to_perim + (1|veg_category), data = sem_data),

  
  lm(soil_surface_severity_mean ~ 
       reserve_percentburn +  dist_to_perim  +
       ppt_mean_overall + tmean_normal, data = sem_data),
  
  lm(reserve_percentburn ~ 
       ppt_mean_overall + tmean_normal, data = sem_data)
)  

summary(mod_inclusive_new)
plot(mod_inclusive_new)
# 5368.449
# Fisher's C = 2.924 with P-value = 0.232 and on 2 degrees of freedom



## with distnace for only unburned plots
mod_inclusive_new_burn <- psem(
  # local model
  lm(log(tick_density+1) ~ 
       soil_surface_severity_mean +
       woody_debris_mean + 
       reserve_percentburn + dist_to_perim_burn +
       tmean_normal + ppt_mean_overall,
     data = sem_data),
  
  lmer(woody_debris_mean ~ 
         soil_surface_severity_mean +
         ppt_mean_overall + tmean_normal + 
         reserve_percentburn + dist_to_perim_burn + (1|veg_category), data = sem_data),

  
  lm(soil_surface_severity_mean ~ 
       reserve_percentburn +  dist_to_perim_burn  +
       ppt_mean_overall + tmean_normal, data = sem_data),
  
  lm(reserve_percentburn ~ 
       ppt_mean_overall + tmean_normal, data = sem_data)
)  

summary(mod_inclusive_new_burn)
plot(mod_inclusive_new_burn)
# 5245.793 (improved)
# Fisher's C = 26.408 with P-value = 0 and on 2 degrees of freedom (but not significant so can't use)

```
NEW- Inclusive model v2
include interaction term
```{r}

mod_inclusive_new2 <- psem(
  # Local tick density model
  lm(log(tick_density + 1) ~ 
       soil_surface_severity_mean +
       woody_debris_mean + 
       reserve_percentburn +
       tmean_normal + ppt_mean_overall +
       treatment * dist_to_perim,  # interaction with main effects
     data = na.omit(sem_data)),

  # Woody debris submodel
  lmer(woody_debris_mean ~ 
         soil_surface_severity_mean +
         ppt_mean_overall + tmean_normal + 
         reserve_percentburn + 
         treatment * dist_to_perim +
         (1 | veg_category),
       data = na.omit(sem_data)),

  # Soil severity submodel
  lm(soil_surface_severity_mean ~ 
       reserve_percentburn +
       ppt_mean_overall + tmean_normal +
       treatment * dist_to_perim,
     data = na.omit(sem_data)),

  # Reserve burn percentage submodel
  lm(reserve_percentburn ~ 
       ppt_mean_overall + tmean_normal,
     data = na.omit(sem_data))
)

# Check model
summary(mod_inclusive_new2)

plot(mod_inclusive_new2)
# 5368.449
# Fisher's C = 2.924 with P-value = 0.232 and on 2 degrees of freedom


```

try again 
```{r}
mod_final <- psem(

  lmer(woody_debris_mean ~ soil_surface_severity_mean + ppt_mean_overall + tmean_normal + reserve_percentburn + treatment + dist_to_perim + (1 | veg_category),
       data = sem_data),

  lm(soil_surface_severity_mean ~ reserve_percentburn + ppt_mean_overall + tmean_normal + dist_to_perim,
     data = sem_data)#,

  lm(reserve_percentburn ~ ppt_mean_overall + tmean_normal,
     data = sem_data)
)

summary(mod_final)
```
NEW Plot-level model
```{r}
(stayed the same)
##  try building out debris
mod_plot_new <- psem(lmer(tick_density ~ 
                        soil_surface_severity_mean + 
                        woody_debris_mean + bare_soil_char_mean  + 
                        #avg_basal_vegetation + 
                        #avg_ash +
                        (1|reserve), data = sem_data),
                 
     lmer(bare_soil_char_mean ~ 
            soil_surface_severity_mean + #avg_ash + 
            (1|reserve), data = sem_data),
     
     lmer(woody_debris_mean ~ 
            soil_surface_severity_mean  + #avg_basal_vegetation + 
            (1|reserve), data = sem_data))

summary(mod_plot_new)

# Fisher's C = 2.341 with P-value = 0.31 and on 2 degrees of freedom
# 5209.567
```

OLD Plot-level model
```{r}
mod_plot <- psem(lmer(tick_density ~ 
                        soil_surface_severity + 
                        avg_woody_debris + avg_bare_soil_char  + 
                        #avg_basal_vegetation + 
                        #avg_ash +
                        (1|reserve), data = sem_data3),
                 
     lmer(avg_bare_soil_char ~ 
            soil_surface_severity + #avg_ash + 
            (1|reserve), data = sem_data3),
     
     lmer(avg_woody_debris ~ 
            soil_surface_severity  + #avg_basal_vegetation + 
            (1|reserve), data = sem_data3))

summary(mod_plot)

# Fisher's C = 2.341 with P-value = 0.31 and on 2 degrees of freedom
# 5209.567
```

NEW Landscape-level model

```{r}



mod_landscape_new <- psem(
  lmer(log(tick_density+1) ~ 
         dist_to_perim + reserve_percentburn + 
         ppt_mean_overall + tmean_normal + (1|treatment),data = sem_data),
  
  lm(reserve_percentburn ~ 
       ppt_mean_overall + tmean_normal, data = sem_data)) #

summary(mod_landscape_new)
# 3049.975
# Fisher's C = 2.924 with P-value = 0.232 and on 2 degrees of freedom
```

OLD Landscape-level model
```{r}
mod_landscape <- psem(
  lmer(log(tick_density+1) ~ 
         distance_to_perim + reserve_burn + 
         precip_cum_mean + tmean_normal + (1|treatment),data = sem_data3),
  
  lm(reserve_burn ~ 
       precip_cum_mean + tmean_normal , data = sem_data3))

summary(mod_landscape)
# 3021.934
# Fisher's C = 4.616 with P-value = 0.099 and on 2 degrees of freedom
```

##Wilcoxon paired - Vegetation
```{r}
## only select burn data
ndvi_burn <- ndvi %>% filter(treatment == "Burn")


## ML
ndvi_burn_2020_ml <- ndvi_burn %>% filter(year == 2020 & reserve == "McLaughlin")
ndvi_burn_2021_ml <- ndvi_burn %>% filter(year == 2021 & reserve == "McLaughlin")
ndvi_burn_2022_ml <- ndvi_burn %>% filter(year == 2022 & reserve == "McLaughlin")

wilcox.test(ndvi_burn_2021_ml$NDVI, ndvi_burn_2020_ml$NDVI,  paired = TRUE)
# V = 19, p-value = 0.4316
# NEW V = 19, p-value = 0.4316

wilcox.test(ndvi_burn_2022_ml$NDVI, ndvi_burn_2020_ml$NDVI, paired = TRUE)
# V = 15, p-value = 0.2324
# NEW V = 32, p-value = 0.6953 (changed)

## QR
ndvi_burn_2020_qr <- ndvi_burn %>% filter(year == 2020 & reserve == "Quail Ridge")
ndvi_burn_2021_qr <- ndvi_burn %>% filter(year == 2021 & reserve == "Quail Ridge")
ndvi_burn_2022_qr <- ndvi_burn %>% filter(year == 2022 & reserve == "Quail Ridge")

wilcox.test(ndvi_burn_2021_qr$NDVI,ndvi_burn_2020_qr$NDVI, paired = TRUE)
# V = 0, p-value = 6.104e-05

wilcox.test(ndvi_burn_2022_qr$NDVI,ndvi_burn_2020_qr$NDVI,  paired = TRUE)
# V = 1, p-value = 0.0001221
# NEW V = 5, p-value = 0.0006104 (changed)

## HT
ndvi_burn_2020_ht <- ndvi_burn %>% filter(year == 2020 & reserve == "Hastings")
ndvi_burn_2021_ht <- ndvi_burn %>% filter(year == 2021 & reserve == "Hastings")
ndvi_burn_2022_ht <- ndvi_burn %>% filter(year == 2022 & reserve == "Hastings")

wilcox.test(ndvi_burn_2021_ht$NDVI, ndvi_burn_2020_ht$NDVI,  paired = TRUE)
# V = 20, p-value = 0.02155
# NEW V = 8, p-value = 0.001526 (changed)

wilcox.test(ndvi_burn_2022_ht$NDVI, ndvi_burn_2020_ht$NDVI, paired = TRUE)
# V = 34, p-value = 0.1514
# V = 1, p-value = 0.0001221 (changed)

## BC
ndvi_burn_2020_bc <- ndvi_burn %>% filter(year == 2020 & reserve == "Big Creek")
ndvi_burn_2021_bc <- ndvi_burn %>% filter(year == 2021 & reserve == "Big Creek")
ndvi_burn_2022_bc <- ndvi_burn %>% filter(year == 2022 & reserve == "Big Creek")

wilcox.test(ndvi_burn_2021_bc$NDVI,ndvi_burn_2020_bc$NDVI, paired = TRUE)
# V = 9, p-value = 0.002014
# NEW V = 0, p-value = 0.0007247 (changed)

wilcox.test(ndvi_burn_2022_bc$NDVI,ndvi_burn_2020_bc$NDVI,  paired = TRUE)
# V = 6, p-value = 0.0008545
# NEW V = 0, p-value = 0.0007247 (changed)
```
NBR
```{r}
## only select burn data
nbr_burn <- nbr %>% filter(treatment == "Burn")


## ML
nbr_ml <- nbr_burn %>% filter(reserve == "McLaughlin")
wilcox.test(nbr_ml$post_NBR, nbr_ml$pre_NBR,  paired = TRUE, conf.int = TRUE)
# V = 0, p-value = 0.001953

## QR
nbr_qr <- nbr_burn %>% filter(reserve == "Quail Ridge")
wilcox.test(nbr_qr$post_NBR, nbr_qr$pre_NBR,  paired = TRUE, conf.int = TRUE)
# V = 0, p-value = 6.104e-05

## HT
nbr_ht <- nbr_burn %>% filter(reserve == "Hastings")
wilcox.test(nbr_ht$post_NBR, nbr_ht$pre_NBR,  paired = TRUE, conf.int = TRUE)
# V = 0, p-value = 6.104e-05

## BC
nbr_bc <- nbr_burn %>% filter(reserve == "Big Creek")
wilcox.test(nbr_bc$post_NBR, nbr_bc$pre_NBR,  paired = TRUE, conf.int = TRUE)
# V = 0, p-value = 0.0006653


```



#Tables

Table 1. 
```{r}

## climate

## % burned
perc_burned %>% 
  group_by(reserve) %>% 
  summarise(reserve_percentburn = round(reserve_percentburn,2))

## mean tick density and se
ticks_clean %>% 
  group_by(reserve, treatment) %>% 
  filter(treatment != "Burn") %>% 
  #filter(treatment == "Burn") %>%
    summarise(tick_density_mean = round(mean(tick_density),2), 
            tick_density_se = round(sd(tick_density) / sqrt(n()),1)) 
```

Table 2
```{r}
ticks_clean %>% 
  group_by(reserve, veg_category, treatment) %>% 
  filter(treatment == "Burn") %>%
  #filter(treatment != "Burn") %>%
    summarise(tick_density_mean = round(mean(tick_density),1), 
            tick_density_se = round(sd(tick_density) / sqrt(n()),1)) 
```

Table 3
```{r}
## only select burn data
ndvi_burn <- ndvi %>% filter(treatment == "Burn")


## ML
ndvi_burn_2020_ml <- ndvi_burn %>% filter(year == 2020 & reserve == "McLaughlin")
ndvi_burn_2021_ml <- ndvi_burn %>% filter(year == 2021 & reserve == "McLaughlin")
ndvi_burn_2022_ml <- ndvi_burn %>% filter(year == 2022 & reserve == "McLaughlin")


wilcox.test(ndvi_burn_2021_ml$NDVI, ndvi_burn_2020_ml$NDVI,  paired = TRUE)
# V = 19, p-value = 0.4316
# NEW
wilcox.test(ndvi_burn_2022_ml$NDVI, ndvi_burn_2020_ml$NDVI, paired = TRUE)
# V = 15, p-value = 0.2324
# NEW

## QR
ndvi_burn_2020_qr <- ndvi_burn %>% filter(year == 2020 & reserve == "Quail Ridge")
ndvi_burn_2021_qr <- ndvi_burn %>% filter(year == 2021 & reserve == "Quail Ridge")
ndvi_burn_2022_qr <- ndvi_burn %>% filter(year == 2022 & reserve == "Quail Ridge")

wilcox.test(ndvi_burn_2021_qr$NDVI,ndvi_burn_2020_qr$NDVI, paired = TRUE)
# V = 0, p-value = 6.104e-05
# NEW
wilcox.test(ndvi_burn_2022_qr$NDVI,ndvi_burn_2020_qr$NDVI,  paired = TRUE)
# V = 1, p-value = 0.0001221
# NEW

## HT
ndvi_burn_2020_ht <- ndvi_burn %>% filter(year == 2020 & reserve == "Hastings")
ndvi_burn_2021_ht <- ndvi_burn %>% filter(year == 2021 & reserve == "Hastings")
ndvi_burn_2022_ht <- ndvi_burn %>% filter(year == 2022 & reserve == "Hastings")

wilcox.test(ndvi_burn_2021_ht$NDVI, ndvi_burn_2020_ht$NDVI,  paired = TRUE)
# V = 20, p-value = 0.02155
# NEW

wilcox.test(ndvi_burn_2022_ht$NDVI, ndvi_burn_2020_ht$NDVI, paired = TRUE)
# V = 34, p-value = 0.1514
# NEW


## BC
ndvi_burn_2020_bc <- ndvi_burn %>% filter(year == 2020 & reserve == "Big Creek")
ndvi_burn_2021_bc <- ndvi_burn %>% filter(year == 2021 & reserve == "Big Creek")
ndvi_burn_2022_bc <- ndvi_burn %>% filter(year == 2022 & reserve == "Big Creek")

wilcox.test(ndvi_burn_2021_bc$NDVI,ndvi_burn_2020_bc$NDVI, paired = TRUE)
# V = 9, p-value = 0.002014
# NEW

wilcox.test(ndvi_burn_2022_bc$NDVI,ndvi_burn_2020_bc$NDVI,  paired = TRUE)
# V = 6, p-value = 0.0008545
# NEW


```



Figuring out SEM

```{r}
library(nlme)
library(lmerTest)
model <-
  # Tick density model
  lmer(log(tick_density + 1) ~ 
       dist_to_perim * treatment + (1|reserve),
     data = sem_data)


summary(model)


plot(model)

vif(model)

# Check residuals
shapiro.test(residuals(model))  # Normality
bptest(model)

# Create a grid of values
library(ggplot2)
library(dplyr)

# Step 1: Generate new data
new_data <- expand.grid(
  dist_to_perim = seq(min(sem_data$dist_to_perim, na.rm = TRUE),
                      max(sem_data$dist_to_perim, na.rm = TRUE),
                      length.out = 100),
  treatment = levels(sem_data$treatment)
)

# Step 2: Predict with confidence intervals (on log scale)
preds_log <- predict(model, newdata = new_data, interval = "confidence")

# Step 3: Back-transform predictions
preds_original <- as.data.frame(preds_log) %>%
  mutate(
    fit = exp(fit) - 1,
    lwr = exp(lwr) - 1,
    upr = exp(upr) - 1
  )

# Step 4: Combine with new_data
new_data <- bind_cols(new_data, preds_original)

# Step 5: Plot
ggplot(sem_data, aes(x = dist_to_perim, y = log(tick_density+1), color = treatment)) +
  geom_point(alpha = 0.4) +
  geom_line(data = new_data, aes(x = dist_to_perim, y = fit, color = treatment), size = 1.2) +
  geom_ribbon(data = new_data, aes(x = dist_to_perim, ymin = lwr, ymax = upr, fill = treatment), alpha = 0.2, inherit.aes = FALSE) +
  labs(
    x = "Distance to Fire Perimeter (m)",
    y = "Predicted Tick Density",
    title = "Predicted Tick Density by Distance and Treatment"
  ) +
  theme_minimal()





```

```{r}
pred <- ggpredict(model, terms = c("dist_to_perim", "treatment"))

ggplot(pred, aes(x = x, y = predicted, color = group, fill = group)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, color = NA) +
  labs(title = "Predicted Log(Tick Density + 1)",
       x = "Distance to Perimeter (m)",
       y = "Log(Tick Density + 1)",
       color = "Treatment", fill = "Treatment") +
  theme_minimal(base_size = 14)


# compute marginal and conditional R2
library(MuMIn)
r.squaredGLMM(model)
# marginal 0.15 (fixed effects only)
# conditional 0.30

library(sjPlot)
tab_model(model,
          show.re.var = TRUE,
          show.icc = TRUE,
          show.r2 = TRUE,
          show.stat = TRUE,
          digits = 3,
          title = "Table S1. Mixed-effects model summary")
```


```{r}

ggplot(sem_data, aes(x = dist_to_perim, 
                     y = log(tick_density + 1), 
                     color = treatment, 
                     fill = treatment)) +
  geom_point(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", 
              formula = y ~ x, 
              se = TRUE, 
              size = 1.2) +
  labs(
    #title = "Effect of Distance to Perimeter and Treatment on Tick Density",
    x = "Distance to Perimeter (m)",
    y = "Log(Tick Density + 1)",
    color = "Treatment",
    fill = "Treatment"
  ) +
  coord_cartesian(xlim = c(0, NA), ylim = c(0, NA)) +
  scale_color_manual(values = c("#f03b20", "#91bfdb")) +
  scale_fill_manual(values = c("#f03b20", "#91bfdb")) +
  #scale_color_brewer(palette = "Dark2") +
  #scale_fill_brewer(palette = "Dark2") +
  theme_minimal(base_size = 14) +
  theme(#legend.title = element_text(face = "bold"),
        axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )


```
```{r}
sem_data2 <- sem_data %>% 
  mutate(treatment = factor(treatment,
                            levels = c("Burn", "Unburn")))
model2 <-
  # Tick density model
  lmer(log(tick_density + 1) ~ 
       dist_to_perim * treatment + (1|reserve),
     data = sem_data2)


summary(model2)

```

